# install.ps1 : This powershell script installs the puppet-agent package from a Puppet Enterprise master
[CmdletBinding()]
Param(
  [string]$server      = "<%= @server_setting %>",
  [string]$certname    = $null,
  [string]$msi_dest    = "$env:temp\puppet-agent-x64.msi",
  [string]$msi_source  = "https://<%= @msi_host %>:8140/packages/current/windows-x86_64/puppet-agent-x64.msi",
  [string]$install_log = "$env:temp\puppet-install.log"
)

#$DebugPreference = 'Continue'

function DownloadPuppet {
  if ($verbose -ne $false) {
    Write-Verbose "Downloading the Puppet Agent for Puppet Enterprise <%= @pe_build %> on $env:COMPUTERNAME..." -verbose
  }
  [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true}
  $webclient = New-Object system.net.webclient
  try {
    $webclient.DownloadFile($msi_source,$msi_dest)
  }
  catch [Net.WebException] {
    Write-Warning "Failed to download the Puppet Agent installer: $msi_source"
    Write-Warning "$_"
    Write-Warning "Does the Puppet Master have the pe_repo::platform::windows_<arch> class applied to it?"
    break
  }
}

function SetTimeServices {
  net stop w32time
  w32tm /config /syncfromflags:manual /manualpeerlist:'<%= @ntp %>'
  w32tm /config /reliable:yes
  net start w32time
  w32tm /resync /force
  #TODO we may have to wait here for the time to resynce
}

function SetDnsServerAddresses ( [string]$interface, [string]$index, [string]$ipv, [string]$dns_servers ) {
  Write-Debug "Set $interface [$index] $ipv DNS Server Addresses to '$dns_servers'"
  $serverAddresses = (Get-DnsClientServerAddress -InterfaceIndex "$index" -AddressFamily $ipv).ServerAddresses
  $addressCount    = $serverAddresses.Count
  Write-Debug "Pre-existing Server Addresses count: $addressCount"
  if ($addressCount) {
    $addressNames = Out-String -InputObject $serverAddresses -Stream
    Write-Debug "Pre-existing Server Addresses: $addressNames"
  }
  #TODO Something isnt' quite right with this logic here
  if (-Not $addressCount -Or '<%= @dns_override %>') {
    $serverAddresses = $dns_servers
    if ($verbose -ne $false) {
      Write-Verbose "Updating $ipv DNS Server Addresses for $interface [$index]: $serverAddresses"
    }
  }
  else {
    if ($verbose -ne $false) {
      Write-Verbose "Keeping existing $ipv DNS Server Addresses for $interface [$index]: $serverAddresses"
    }
  }
  $serverAddresses = Out-String -InputObject $serverAddresses -Stream
  if (-Not $serverAddresses) {
    Write-Debug "No $ipv DNS Server Addresses defined for $interface [$index]."
    return $false
  }
  Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses '$serverAddresses'<% if @validate_dns %> -Validate<% end %>
  return $true
}

function SetDnsServices {
  try {
<% if @interface_index != '' -%>
    $index     = '<%= @interface_index %>'
    $interface = (Get-DnsClientServerAddress -IntefaceIndex $index)[0].InterfaceAlias
<% else -%>
    $interface = '<%= @interface %>'
    $index     = (Get-DnsClientServerAddress -InterfaceAlias $interface)[0].InterfaceIndex
<% end -%>
  }
  catch {
<% if @interface_index != '' -%>
    Throw "Invalid interface_index specified: '<%= @interface_index %>'"
<% else -%>
    Throw "Invalid interface_alias specified: '<%= @interface %>'"
<% end -%>
    break
  }
  if (-Not $index -Or -Not $interface) {
    Throw 'Cannot find the requested interface on host. Unable to configure/verify DNS.'
    break
  }
  Write-Debug "InterfaceAlias: $interface"
  Write-Debug "InterfaceIndex: $index"
  if ($verbose -ne $false) {
    Write-Verbose "Setting DNS Server Addresses for $interface [$index]"
  }
  try {
    Write-Debug "Set-DnsClientServers will <% unless $validate_dns 
                                     %>not <% end %>attempt to validate the supplied DNS servers."
    $ipv4_rc = SetDnsServerAddresses $interface $index 'IPv4' '<%= @dns4 %>'
    $ipv6_rc = SetDnsServerAddresses $interface $index 'IPv6' '<%= @dns6 %>'
    if ($ipv4_rc -Or $ipv6_rc) {
      if ($verbose -ne $false) {
        Write-Verbose "Successfully configured DNS Server Addresses for $interface [$index]."
      }
    }
  }
  catch {
    if ($_.Exception.GetType().FullName -eq 'Microsoft.Management.Infrastructure.CimException') {
      Throw "Failed to set the DNS Server Addresses for $interface [$index]. Check the provided/existing server addresses."
      break
    }
    else {
      throw $_.Exception
    }
  }
}

function GetCertname {
  if (![string]::IsNullOrEmpty($certname)) {
    $certname.ToLower()
  } else {
    $objIPProperties = [System.Net.NetworkInformation.IPGlobalProperties]::GetIPGlobalProperties()
    $name_components = @($objIPProperties.HostName, $objIPProperties.DomainName) | ? {$_}
    $certname        = $name_components -Join "."
    $certname.ToLower()
  }
}

function InstallPuppet {
  $real_certname = GetCertname
  if ([string]::IsNullOrEmpty($real_certname)) {
    Throw 'Unable to determine a certname to use. Halting installation...'
    break
  }
  if ($verbose -ne $false) {
    Write-Verbose "Using certname => $real_certname" -verbose
    Write-Verbose "Using server   => $server" -verbose
    Write-Verbose "Saving the install log to $install_log" -verbose
    Write-Verbose "Installing the Puppet Agent on $env:COMPUTERNAME..." -verbose
  }
  $msiexec_path = "C:\Windows\System32\msiexec.exe"
  $msiexec_args = "/qn /log $install_log /i $msi_dest PUPPET_MASTER_SERVER=$server PUPPET_AGENT_CERTNAME=$real_certname"
  $msiexec_proc = [System.Diagnostics.Process]::Start($msiexec_path, $msiexec_args)
  $msiexec_proc.WaitForExit()
}

function ValidateInstall {
  If ((Get-WmiObject -Class Win32_Product).Name -match 'Puppet') {
    If ($verbose -ne $false) {
      Write-Verbose "The Puppet Agent has been installed on $env:COMPUTERNAME" -verbose
    }
  } else {
      Throw {"Something went wrong with the installation on $env:COMPUTERNAME.  Check the install log at: $install_log" }
      break
  }
}

DownloadPuppet
SetTimeServices
SetDnsServices
InstallPuppet
ValidateInstall

if ($verbose -ne $false) {
  Write-Verbose "Installation has completed." -verbose
}
