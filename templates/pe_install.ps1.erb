# pe_install.ps1 : This powershell script installs the puppet-agent package from a Puppet Enterprise master
[CmdletBinding()]

Param(
  [string]$installdir             = $null,
  [string]$server                 = "<%= @server_setting %>",
  [string]$ca_server              = $null,
  [string]$certname               = $null,
  [string]$agent_environment      = $null,
  [string]$agent_startup_mode     = $null,
  [string]$agent_account_user     = $null,
  [string]$agent_account_password = $null,
  [string]$agent_account_domain   = $null,
  [string]$msi_dest               = "$env:temp\puppet-agent-x64.msi",
  [string]$msi_source             = "https://<%= @msi_host %>:8140/packages/current/windows-x86_64/puppet-agent-x64.msi",
  [string]$install_log            = "$env:temp\puppet-install.log"
)
# Uncomment the following line to enable debugging messages. Alternatively, this variable can be set in the shell.
#$DebugPreference = 'Continue'

function ValidateParameters {
  if (Get-Command Test-NetConnection -errorAction SilentlyContinue) {
    Write-Verbose 'Validating server connections.'
    $checkPort  = 8140
    $msiHost    = ([System.Uri]$msi_source).Host
    $checkHosts = ($server, $msiHost)
    foreach ($checkHost in $checkHosts) {
      Write-Verbose "Checking connection to ${checkHost}:${checkPort}."
      $checkJob = Start-Job -ScriptBlock {
        param($checkHost, $checkPort)
        Test-NetConnection -ComputerName "${checkHost}" -Port $checkPort -InformationLevel Quiet
      } -ArgumentList ($CheckHost, $CheckPort)
      Out-String -InputObject $checkJob -Stream | Write-Debug
      $rc = Wait-Job $checkJob
      Out-String -InputObject $rc -Stream | Write-Debug
      $rc = Receive-Job $checkJob -OutVariable testResult
      Out-String -InputObject $rc -Stream | Write-Debug
      if ($testResult) {
        Write-Verbose "Successful connection to ${checkHost}:${checkPort}."
      }
      else {
        Throw "Failed to connect to ${checkHost}:${checkPort}"
        break
      }
    }
  }
  else {
    Write-Debug 'Test-NetConnection cmdlet is not available. Skipping connection tests.'
  }
}

function DownloadPuppet {
  Write-Verbose "Downloading the Puppet Agent for Puppet Enterprise <%= @pe_build %> on $env:COMPUTERNAME..."
  [System.Net.ServicePointManager]::ServerCertificateValidationCallback={$true}
  $webclient = New-Object system.net.webclient
  try {
    $webclient.DownloadFile($msi_source,$msi_dest)
  }
  catch [Net.WebException] {
    Write-Warning "Failed to download the Puppet Agent installer: ${msi_source}"
    Write-Warning "$_"
    Write-Warning 'Does the Puppet Master have the pe_repo::platform::windows_<arch> class applied to it?'
    break
  }
}

function GetCertname {
  if (![string]::IsNullOrEmpty($certname)) {
    $certname.ToLower()
  } else {
    $objIPProperties = [System.Net.NetworkInformation.IPGlobalProperties]::GetIPGlobalProperties()
    $name_components = @($objIPProperties.HostName, $objIPProperties.DomainName) | ? {$_}
    $certname        = $name_components -Join "."
    if ([string]::IsNullOrEmpty($certname)) {
      Throw 'Unable to determine a certname to use. Halting installation...'
      break
    }
    $certname.ToLower()
  }
}

function BuildMSIProperties {
  # Create an empty list (they're more memory efficient than arrays).
  $msi_properties = New-Object System.Collections.Generic.List[System.Object]

  # Check for INSTALLDIR
  if (![string]::IsNullOrEmpty($insalldir)) {
    $msi_properties.Add("INSTALLDIR=${installdir}")
  }

  # Check for PUPPET_MASTER_SERVER
  if (![string]::IsNullOrEmpty($server)) {
    $msi_properties.Add("PUPPET_MASTER_SERVER=${server}")
  }

  # Check for PUPPET_CA_SERVER
  if (![string]::IsNullOrEmpty($ca_server)) {
    $msi_properties.Add("PUPPET_CA_SERVER=${ca_server}")
  }

  # Check for PUPPET_AGENT_CERTNAME
  $real_certname = GetCertname
  $msi_properties.Add("PUPPET_AGENT_CERTNAME=${real_certname}")

  # Check for PUPPET_AGENT_ENVIRONMENT
  if (![string]::IsNullOrEmpty($agent_environment)) {
    $msi_properties.Add("PUPPET_AGENT_ENVIRONMENT=${agent_environment}")
  }

  # Check for PUPPET_AGENT_STARTUP_MODE
  if (![string]::IsNullOrEmpty($agent_startup_mode)) {
    $msi_properties.Add("PUPPET_AGENT_STARTUP_MODE=${agent_startup_mode}")
  }

  # Check for PUPPET_AGENT_ACCOUNT_USER
  if (![string]::IsNullOrEmpty($agent_account_user)) {
    $msi_properties.Add("PUPPET_AGENT_ACCOUNT_USER=${agent_account_user}")
  }

  # Check for PUPPET_AGENT_ACCOUNT_PASSWORD
  if (![string]::IsNullOrEmpty($agent_account_password)) {
    $msi_properties.Add("PUPPET_AGENT_ACCOUNT_PASSWORD=${agent_account_password}")
  }

  # Check for PUPPET_AGENT_ACCOUNT_DOMAIN
  if (![string]::IsNullOrEmpty($agent_account_domain)) {
    $msi_properties.Add("PUPPET_AGENT_ACCOUNT_DOMAIN=${agent_account_domain}")
  }

  # Return the argument list.
  $msi_properties -Join " "
}

function InstallPuppet {

  $install_options = BuildMSIProperties
  Write-Verbose "Using the following MSI Properties: ${install_options}"

  Write-Verbose "Saving the install log to ${install_log}."
  Write-Verbose "Installing the Puppet Agent on $env:COMPUTERNAME..."

  $msiexec_path = "C:\Windows\System32\msiexec.exe"
  $msiexec_args = "/qn /log ${install_log} /i ${msi_dest} ${install_options}"

  Write-Debug  "Executing: ${msiexec_path} ${msiexec_args}"
  $msiexec_proc = [System.Diagnostics.Process]::Start($msiexec_path, $msiexec_args)
  $msiexec_proc.WaitForExit()
}

function ValidateInstall {
  Write-Verbose 'Validating Puppet Agent.'
  Write-Debug   'Checking if WmiObject exists for Puppet.'
  If ((Get-WmiObject -Class Win32_Product).Name -Match 'Puppet') {
    Write-Verbose "The Puppet Agent has been installed on $env:COMPUTERNAME."
  }
  else {
    Throw "Something went wrong with the installation on $env:COMPUTERNAME.  Check the install log at: ${install_log}"
    break
  }
  Write-Debug 'Validating Puppet Agent service is running.'
  $puppetStatus = (Get-Service -Name Puppet).Status
  if ($puppetStatus -eq 'running') {
    Write-Verbose "The Puppet Agent is running on $env:COMPUTERNAME"
  }
  else {
    Write-Debug "Puppet Agent Status: ${puppetStatus}"
    Throw "Something went wrong with starting the Puppet Agent on $env:COMPUTERNAME.  Check the install log at: ${install_log}"
    break
  }
}

ValidateParameters
DownloadPuppet
InstallPuppet
ValidateInstall
Write-Verbose "Installation has completed."

